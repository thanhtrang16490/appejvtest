---
import { languages, getLangFromUrl, type Language } from '../i18n/languages'
import { getBasePath, getLocalizedPath } from '../i18n/url-utils'

const currentLang = getLangFromUrl(Astro.url)
const currentPath = Astro.url.pathname
const basePath = getBasePath(currentPath)
---

<div class="relative inline-block text-left" id="language-switcher">
  <button
    type="button"
    class="inline-flex items-center gap-1.5 text-[12px] font-normal text-gray-800 hover:text-gray-900 transition-colors duration-200 tracking-tight"
    id="language-button"
    aria-expanded="false"
    aria-haspopup="true"
  >
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
    </svg>
    <span>{currentLang === 'vi' ? 'VI' : currentLang === 'en' ? 'EN' : 'CN'}</span>
    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
      <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
    </svg>
  </button>

  <!-- Dropdown menu -->
  <div
    id="language-menu"
    class="absolute right-0 mt-2 w-36 origin-top-right rounded-lg bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none opacity-0 scale-95 pointer-events-none transition-all duration-200"
    role="menu"
    aria-orientation="vertical"
    aria-labelledby="language-button"
  >
    <div class="py-1" role="none">
      <a
        href={getLocalizedPath(currentPath, 'vi')}
        class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors"
        class:list={[currentLang === 'vi' && 'bg-gray-50 font-semibold']}
        role="menuitem"
      >
        ðŸ‡»ðŸ‡³ Tiáº¿ng Viá»‡t
      </a>
      <a
        href={getLocalizedPath(currentPath, 'en')}
        class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors"
        class:list={[currentLang === 'en' && 'bg-gray-50 font-semibold']}
        role="menuitem"
      >
        ðŸ‡¬ðŸ‡§ English
      </a>
      <a
        href={getLocalizedPath(currentPath, 'cn')}
        class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors"
        class:list={[currentLang === 'cn' && 'bg-gray-50 font-semibold']}
        role="menuitem"
      >
        ðŸ‡¨ðŸ‡³ ä¸­æ–‡
      </a>
    </div>
  </div>
</div>

<script>
  const button = document.getElementById('language-button')
  const menu = document.getElementById('language-menu')
  const switcher = document.getElementById('language-switcher')

  function toggleMenu() {
    const isOpen = menu?.classList.contains('opacity-100')
    
    if (isOpen) {
      menu?.classList.remove('opacity-100', 'scale-100')
      menu?.classList.add('opacity-0', 'scale-95', 'pointer-events-none')
      button?.setAttribute('aria-expanded', 'false')
    } else {
      menu?.classList.remove('opacity-0', 'scale-95', 'pointer-events-none')
      menu?.classList.add('opacity-100', 'scale-100')
      button?.setAttribute('aria-expanded', 'true')
    }
  }

  button?.addEventListener('click', (e) => {
    e.stopPropagation()
    toggleMenu()
  })

  // Close menu when clicking outside
  document.addEventListener('click', (e) => {
    if (!switcher?.contains(e.target as Node)) {
      menu?.classList.remove('opacity-100', 'scale-100')
      menu?.classList.add('opacity-0', 'scale-95', 'pointer-events-none')
      button?.setAttribute('aria-expanded', 'false')
    }
  })

  // Close menu on escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      menu?.classList.remove('opacity-100', 'scale-100')
      menu?.classList.add('opacity-0', 'scale-95', 'pointer-events-none')
      button?.setAttribute('aria-expanded', 'false')
    }
  })
</script>
